<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>GPS 定位監控</title>

    <link href="http://terikon.github.io/marker-animate-unobtrusive/demo/unobtrusive/map.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">

    <link href="/static/css/history_control.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="/static/css/history_menu.css" />
    <link rel="stylesheet" href="/static/css/master_supervise.css">
    <link rel="stylesheet" href="/static/css/master_history.css">

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD_xrySG3MlQuGCwglYYeXztFQehgNGDbw&libraries=geometry"></script>
    <script src="https://code.jquery.com/jquery.min.js"></script>
    <script src="http://terikon.github.io/marker-animate-unobtrusive/demo/vendor/jquery.easing.1.3.js"></script>
    <script src="http://terikon.github.io/marker-animate-unobtrusive/demo/vendor/markerAnimate.js"></script>
    <script src="http://terikon.github.io/marker-animate-unobtrusive/demo/SlidingMarker.js"></script>

    <!-- MQTT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>

    <script>
    var map,polyline,area,setarea,set_ana,temp1 = 0, temp2 = 0;
    var polys = [], p;
    var point_array = [];
    function initialize(){
      var myLatlng = new google.maps.LatLng(24.944, 121.3695);
      var mapOptions = {
        zoom: 16.5,
        center: myLatlng,
        zoomControl: true,
        scaleControl: false,
        rotateControl: false,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      }
      map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);
    }


    function setline(){
      var points= [];
      {% for data in datas %}

      var temp = {lat: {{data.latitude}}, lng: {{data.longitude}}};
      points.push(temp);
      {% endfor %}
      console.log(points);
      if(!polyline){
        polyline = new google.maps.Polyline({
          path: points,
          strokeColor: '#FF0000',
          strokeOpacity: 0.7,
          strokeWeight:  5
        });
      }
      polyline.setMap(map);
    }

      function remove_line(){
        polyline.setMap(null);
      }

      function set_area(points){
        if(temp2 == 0){
          var w = 0.00005;
          var h = w;

          for(var i = 0; i < points.length; i++){
            var fence = [
            {lat: points[i][0] + h, lng: points[i][1] - w},
            {lat: points[i][0] + h, lng: points[i][1] + w},
            {lat: points[i][0] - h, lng: points[i][1] + w},
            {lat: points[i][0] - h, lng: points[i][1] - w}
            ];

            setarea = new google.maps.Polygon({
              position: {lat: points[i][0], lng: points[i][1]},
              path: fence,
              strokeColor: '#FF0000',  
              strokeOpacity: 0,  
              strokeWeight: 1,  
              fillColor: '#FF0000',  
              fillOpacity: 0.4
            });
            point_array.push(setarea);
            setarea.setMap(map);
          }
          temp2 = 1;
        }
        else{
          for(var i = 0; i < points.length; i++){
            point_array[i].setMap(null);
          }
          point_array = [];
          temp2 = 0;
        }
      }
///////////////////////////////////////////////////////////////////////////////////////

$(function () {
  initialize(null);
  console.log("func");
});

function toggleSidebar(){
  document.getElementById("sidebar").classList.toggle('active');
}
</script>

<style src = "style.css"></style>

</head>
  <body>
    <div id="wrapper">
      <header class="navbar u-cf">
        <div class="container">
          <div class="title">
              <h2>管理者模式</h2>
          </div>
          <ul class="menu">
            <li>
              <a href="{{ url_for('home') }}"><i class ="fas fa-home" ></i>首頁</a>
            </li>
            <li>
              <a href="{{ url_for('master_supervise') }}"><i class ="fas fa-shoe-prints"></i>即時追蹤</a>
            </li>
            <li>
              <a href="{{ url_for('master_history') }}"  class="current"><i class ="fas fa-history" ></i>歷史分析</a>
            </li>
            <li>
              <a href="#person"><i class ="fas fa-cog" ></i>觀看設定</a>
            </li>
          </ul>
        </div>
      </header>
      <!-- person -->
        <div id="person">
          <form method="post" action= "#people">
            <div class="cancel">
              <a href="#"><i class="far fa-times-circle fa-3x" style="color: rgba(256,256,256,0.9);"></i></a>
            </div>
            <div class="row">
              <div class="people_container">
                <h3 style="text-align: center;">選擇欲觀看人員</h3>
                <div class="small_container">
                  {% for friend in Friends %}
                    <div class="friend-list">
                      <div class="friends-pic" style="background-image: url('{{friend_pic[Friends.index(friend)]}}')"></div>
                      <div class="friends"> {{ friend }} </div>
                      <input type="submit" name="choose_person" value="{{friend}}" />
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </form>
        </div>
      <!-- people -->
      <div id="people">
        <div class="cancel">
          <a href="#"><i class="far fa-times-circle fa-3x" style="color: rgba(256,256,256,0.9);"></i></a>
        </div>
        <div class="row">
          <div class="people_container">
            <h2 style="text-align: center;">設定</h2>
            <div class="tool">
              <form method="POST" action="{{ url_for('master_history_display') }}">
               {{ select.csrf_token }}
               <div class="set">
                {{select.user.label}}
                <p>{{chosen_person}}</p>
               </div>

               <div class="set">
                 {{ select.date.label }}
                 {{ select.date }}
               </div>

               <div class="set">
                 {{ select.begin_time.label }}
                 {{ select.begin_time }}
               </div>

               <div class="set">
                {{ select.duration.label }}
                 {{ select.duration }}
               </div>

               <div class="set">
                 <input type="submit" value="顯示歷史路徑">
               </div>
              </form>

              <div class="set">
                <a href = "#"><input type="submit" onclick="remove_line()" value="刪除歷史路徑" href = "#"></a>
              </div>
              <div class="set">
                <a href="#"><input type="submit" onclick="set_area({{ points }})"value="顯示/刪除安全範圍"></a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="map_canvas"></div>
    </div>
  </body>
</html>
